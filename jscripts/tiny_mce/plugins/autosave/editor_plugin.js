(function(){pluginName="autosave",useLocalStorage=false,useSessionStorage=false,useUserData=false,cookieEncodeKey={"%":"%1","&":"%2",";":"%3","=":"%4","<":"%5"},cookieDecodeKey={"%1":"%","%2":"&","%3":";","%4":"=","%5":"<"},preloadImages=[],instanceSettings={},testKey="TinyAutoSave_Test_",userDataElement=null,settingsTemplate={dataKey:"TinyAutoSave",cookieFilter:null,saveDelegate:null,saveFinalDelegate:null,restoreDelegate:null,disposeDelegate:null,restoreImage:"",progressImage:"progress.gif",intervalSeconds:60,retentionMinutes:20,minSaveLength:50,canRestore:false,busy:false,timer:null};try{localStorage.setItem(testKey,"OK");if(localStorage.getItem(testKey)==="OK"){localStorage.removeItem(testKey);useLocalStorage=true}}catch(h){try{sessionStorage.setItem(testKey,"OK");if(sessionStorage.getItem(testKey)==="OK"){sessionStorage.removeItem(testKey);useSessionStorage=true}}catch(h){useUserData=tinymce.isIE}}tinymce.PluginManager.requireLangPack(pluginName);tinymce.create("tinymce.plugins.AutoSavePlugin",{editor:null,url:"",key:"",onPreSave:null,onPostSave:null,onSaveError:null,onPreRestore:null,onPostRestore:null,onRestoreError:null,showSaveProgress:true,progressDisplayTime:1200,init:function(e,u){var v=this,x=tinymce.is,A=tinymce.resolve,w,z,y;if(useUserData){if(!userDataElement){userDataElement=e.getElement()}userDataElement.style.behavior="url('#default#userData')"}v.editor=e;v.id=e.id;v.url=u;v.key=e.getParam(pluginName+"_key",e.id);w=a(v);w.restoreImage=u+"/images/restore."+(tinymce.isIE6?"gif":"png");v.setProgressImage(u+"/images/"+settingsTemplate.progressImage);w.intervalSeconds=Math.max(1,parseInt(e.getParam(pluginName+"_interval_seconds",null)||e.getParam(pluginName+"_interval",w.intervalSeconds)));w.retentionMinutes=Math.max(1,parseInt(e.getParam(pluginName+"_retention_minutes",null)||e.getParam(pluginName+"_retention",w.retentionMinutes)));w.minSaveLength=Math.max(1,parseInt(e.getParam(pluginName+"_minlength",w.minSaveLength)));v.showSaveProgress=e.getParam(pluginName+"_showsaveprogress",v.showSaveProgress);w.canRestore=v.hasSavedContent();w.saveDelegate=f(v,k);w.saveFinalDelegate=f(v,c);w.restoreDelegate=f(v,l);e.addCommand("mceAutoSave",w.saveDelegate);e.addCommand("mceAutoSaveRestore",w.restoreDelegate);e.addButton(pluginName,{title:pluginName+".restore_content",cmd:"mceAutoSaveRestore",image:w.restoreImage});w.timer=window.setInterval(w.saveDelegate,w.intervalSeconds*1000);tinymce.dom.Event.add(window,"unload",w.saveFinalDelegate);e.onRemove.add(w.saveFinalDelegate);e.onPostRender.add(function(t,s){t.controlManager.setDisabled(pluginName,!w.canRestore)});z=e.getParam(pluginName+"_oninit",null);if(x(z,"string")){y=A(z);if(x(y,"function")){y.apply(v)}}if(e.getParam(pluginName+"_ask_beforeunload",true)){window.onbeforeunload=tinymce.plugins.AutoSavePlugin._beforeUnloadHandler}},getInfo:function(){return{longname:"Auto save",author:"Moxiecode Systems AB",authorurl:"http://tinymce.moxiecode.com",infourl:"http://wiki.moxiecode.com/index.php/TinyMCE:Plugins/autosave",version:tinymce.majorVersion+"."+tinymce.minorVersion}},clear:function(){var u=this,e=u.editor,v=g(u);if(useLocalStorage){localStorage.removeItem(v.dataKey)}else{if(useSessionStorage){sessionStorage.removeItem(v.dataKey)}else{if(useUserData){j(u)}else{tinymce.util.Cookie.remove(v.dataKey)}}}v.canRestore=false;e.controlManager.setDisabled(pluginName,u)},hasSavedContent:function(){var w=this,x=g(w),u=new Date(),y,v;try{if(useLocalStorage||useSessionStorage){y=((useLocalStorage?localStorage.getItem(x.dataKey):sessionStorage.getItem(x.dataKey))||"").toString(),v=y.indexOf(",");if((v>8)&&(v<y.length-1)){if((new Date(y.slice(0,v)))>u){return true}if(useLocalStorage){localStorage.removeItem(x.dataKey)}else{sessionStorage.removeItem(x.dataKey)}}return false}else{if(useUserData){return((i(w)||"").length>0)}}return((tinymce.util.Cookie.get(x.dataKey)||"").length>0)}catch(z){return false}},setProgressImage:function(e){if(tinymce.is(e,"string")){o(g(this).progressImage=e)}},"static":{_beforeUnloadHandler:function(){var e;tinymce.each(tinyMCE.editors,function(s){if(s.getParam("fullscreen_is_enabled")){return}if(s.isDirty()){e=s.getLang("autosave.unload_msg");return false}});return e}}});function p(){var e=this,u=g(e);if(u.timer){window.clearInterval(u.timer)}tinymce.dom.Event.remove(window,"unload",u.saveFinalDelegate);e.editor.onRemove.remove(u.saveFinalDelegate);q(e)}function c(){var e=g(this);e.saveDelegate();e.disposeDelegate()}function k(){var G=this,z=G.editor,H=g(G),y=tinymce.is,v=z.execCallback,F=false,u=new Date(),B,w,D,C,E,x;if((z)&&(!H.busy)){H.busy=true;if(y(G.onPreSave,"string")){if(!v(G.onPreSave)){H.busy=false;return false}}B=z.getContent();if(y(B,"string")&&(B.length>=H.minSaveLength)){w=new Date(u.getTime()+(H.retentionMinutes*60*1000));try{if(useLocalStorage){localStorage.setItem(H.dataKey,w.toString()+","+r(B))}else{if(useSessionStorage){sessionStorage.setItem(H.dataKey,w.toString()+","+r(B))}else{if(useUserData){d(G,B,w)}else{D=H.dataKey+"=";C="; expires="+w.toUTCString();document.cookie=D+b(B).slice(0,4096-D.length-C.length)+C}}}F=true}catch(A){if(y(G.onSaveError,"string")){v(G.onSaveError)}}if(F){E=z.controlManager;H.canRestore=true;E.setDisabled(pluginName,false);if(G.showSaveProgress){C=tinymce.DOM.get(E.get(pluginName).id);if(C){x=H.restoreImage;C.firstChild.src=H.progressImage;window.setTimeout(function(){C.firstChild.src=x},Math.min(G.progressDisplayTime,H.intervalSeconds*1000-100))}}if(y(G.onPostSave,"string")){v(G.onPostSave)}}}H.busy=false}return F}function l(){var B=this,y=B.editor,C=g(B),A=null,x=tinymce.is,u=y.execCallback,w,v;if((y)&&(C.canRestore)&&(!C.busy)){C.busy=true;if(x(B.onPreRestore,"string")){if(!u(B.onPreRestore)){C.busy=false;return}}try{if(useLocalStorage||useSessionStorage){A=((useLocalStorage?localStorage.getItem(C.dataKey):sessionStorage.getItem(C.dataKey))||"").toString();w=A.indexOf(",");if(w==-1){A=null}else{A=m(A.slice(w+1,A.length))}}else{if(useUserData){A=i(B)}else{v=C.cookieFilter.exec(document.cookie);if(v){A=n(v[1])}}}if(!x(A,"string")){y.windowManager.alert(pluginName+".no_content")}else{if(y.getContent().replace(/\s|&nbsp;|<\/?p[^>]*>|<br[^>]*>/gi,"").length===0){y.setContent(A);if(x(B.onPostRestore,"string")){u(B.onPostRestore)}}else{y.windowManager.confirm(pluginName+".warning_message",function(e){if(e){y.setContent(A);if(x(B.onPostRestore,"string")){u(B.onPostRestore)}}C.busy=false},B)}}}catch(z){if(x(B.onRestoreError,"string")){u(B.onRestoreError)}}C.busy=false}}function d(e,t,s){userDataElement.setAttribute(g(e).dataKey,t);userDataElement.expires=s.toUTCString();userDataElement.save("TinyMCE")}function i(e){userDataElement.load("TinyMCE");return userDataElement.getAttribute(g(e).dataKey)}function j(e){userDataElement.removeAttribute(g(e).dataKey)}function b(e){return e.replace(/[\x00-\x1f]+|&nbsp;|&#160;/gi," ").replace(/(.)\1{5,}|[%&;=<]/g,function(s){if(s.length>1){return("%0"+s.charAt(0)+s.length.toString()+"%")}return cookieEncodeKey[s]})}function n(e){return e.replace(/%[1-5]|%0(.)(\d+)%/g,function(x,s,w){var u,v,t;if(x.length==2){return cookieDecodeKey[x]}for(u=[],v=0,t=parseInt(w);v<t;v++){u.push(s)}return u.join("")})}function r(e){return e.replace(/,/g,"&#44;")}function m(e){return e.replace(/&#44;/g,",")}function o(s){var e=preloadImages.length;preloadImages[e]=new Image();preloadImages[e].src=s}function f(e,s){return function(){return s.apply(e)}}function a(u){var e=u.key,t=instanceSettings[e];if(!t){t=instanceSettings[e]=tinymce.extend({},settingsTemplate,{dataKey:settingsTemplate.dataKey+e,saveDelegate:f(u,k),saveFinalDelegate:f(u,c),restoreDelegate:f(u,l),disposeDelegate:f(u,p),cookieFilter:new RegExp("(?:^|;\\s*)"+settingsTemplate.dataKey+e+"=([^;]*)(?:;|$)","i")})}return t}function g(e){return instanceSettings[e.key]}function q(e){delete instanceSettings[e.key]}tinymce.PluginManager.add(pluginName,tinymce.plugins.AutoSavePlugin)})();